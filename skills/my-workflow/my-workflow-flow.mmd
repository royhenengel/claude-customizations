%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#1e3a5f', 'primaryTextColor': '#fff', 'lineColor': '#63b3ed', 'fontSize': '14px'}}}%%
flowchart TD
    %% MAIN FLOW - Simple linear with branches

    START["ðŸš€ /start"]
    START --> CHECK{HANDOFF.md?}

    CHECK -->|Yes| RESUME["Resume previous session"]
    CHECK -->|No| NEW{New project?}

    NEW -->|Brainstorm| BRAIN["ðŸ’­ /brainstorm"]
    NEW -->|Direct| DEFINE["Define project"]

    BRAIN --> SPEC1["SPEC.md + RESEARCH.md"]
    DEFINE --> DOCS1["OVERVIEW.md<br/>CLAUDE.md<br/>STATE.md"]

    RESUME --> PLAN
    DOCS1 --> PLAN
    SPEC1 --> PLAN

    PLAN["ðŸ“ /plan"]
    PLAN --> UNCLEAR{Requirements clear?}

    UNCLEAR -->|No| OFFER["Offer /brainstorm"]
    OFFER --> BRAIN
    UNCLEAR -->|Yes| GATHER["Gather requirements"]

    GATHER --> MARKERS["SPEC.md with<br/>[NEEDS CLARIFICATION]"]
    MARKERS --> RESOLVED{All resolved?}
    RESOLVED -->|No| MARKERS
    RESOLVED -->|Yes| PLANDOCS["RESEARCH.md<br/>PLAN.md"]

    PLANDOCS --> BUILD["ðŸ”¨ /build"]

    BUILD --> EXEC["Execute task via subagent<br/>Fresh 200k context"]
    EXEC --> TYPE{Task Type}

    TYPE --> AUTO["auto"]
    TYPE --> VERIFY["checkpoint:human-verify"]
    TYPE --> DECIDE["checkpoint:decision"]
    TYPE --> ACTION["checkpoint:human-action"]

    AUTO --> DEV
    VERIFY --> DEV
    DECIDE --> DEV
    ACTION --> DEV

    DEV{Deviation?}
    DEV -->|Bug - code| FIX["Auto-fix code"]
    DEV -->|Blocker - env| FIXENV["Auto-fix env"]
    DEV -->|Security gap| ADDSEC["Auto-add critical"]
    DEV -->|Architecture| ASK["STOP + ASK"]
    DEV -->|Enhancement| LOG["Log to BACKLOG.md"]
    DEV -->|Gap detected| GAP["Gap Protocol"]

    FIX --> MORE
    FIXENV --> MORE
    ADDSEC --> MORE
    LOG --> MORE
    GAP --> GAPPROT["PRESERVE â†’ SCOPE â†’<br/>MODIFY â†’ EXECUTE â†’ RETURN"]
    GAPPROT --> MORE

    MORE{More tasks?}
    MORE -->|Yes| CTX{Context?}
    CTX -->|"> 15%"| EXEC
    CTX -->|"< 15%"| OFFERSTOP["Offer /stop"]
    CTX -->|"< 10%"| AUTOSTOP["Auto /stop"]

    MORE -->|No| SUMMARY["SUMMARY.md"]
    SUMMARY --> DONE(["âœ… COMPLETE"])

    %% STOP SECTION
    STOP["ðŸ›‘ /stop"]
    ASK --> STOP
    OFFERSTOP --> STOP
    AUTOSTOP --> STOP

    STOP --> PARK["Park context"]
    PARK --> HANDOFF["HANDOFF.md"]
    HANDOFF --> PARKED(["âœ… PARKED"])
    PARKED -.->|Next session| CHECK

    %% Styling
    style START fill:#1e3a5f,stroke:#3d5a80,stroke-width:2px,color:#fff
    style BRAIN fill:#2d4a3f,stroke:#4a7c59,stroke-width:2px,color:#fff
    style PLAN fill:#3d3a5f,stroke:#5d5a80,stroke-width:2px,color:#fff
    style BUILD fill:#4a3a2f,stroke:#7a5a3f,stroke-width:2px,color:#fff
    style STOP fill:#5f1e1e,stroke:#803d3d,stroke-width:2px,color:#fff
    style DONE fill:#2d4a3f,stroke:#4a7c59
    style PARKED fill:#2d4a3f,stroke:#4a7c59
