# Incident Report: Auto-Trigger-Fix False Positives

**Date**: 2026-02-05
**Severity**: Medium (noise/annoyance, not data loss)
**Status**: Hooks disabled pending fix

## Summary

The auto-trigger-fix hooks produced excessive false positive detections, causing "hook error" messages to appear repeatedly during normal work.

## Affected Components

1. **PostToolUse:Bash hook** (`hooks/scripts/issue-detector-tool-hook.js`)
2. **UserPromptSubmit hook** (`hooks/scripts/user-issue-hook.js`)
3. **Shared detection logic** (`hooks/scripts/detect-issue.js`)

## Issues Identified

### Issue 1: Overly Broad Error Pattern in Tool Output Detection

**Location**: `detect-issue.js` line 105

```javascript
buildFailures: [
  /\bFAILED\b/,
  /error:/i,  // <-- Too broad
  // ...
]
```

**Problem**: The pattern `/error:/i` matches any output containing "error:" regardless of context:
- Grep results searching for errors
- Log file content
- Debug output
- Any text containing "error:"

**Impact**: Every Bash command with output containing "error:" triggered a false positive, showing "PostToolUse:Bash hook error" message.

### Issue 2: Overly Broad Error Pattern in User Message Detection

**Location**: `detect-issue.js` lines 21-28

```javascript
errorKeywords: [
  /\berror\b/i,  // <-- Too broad for user messages
  /\bbug\b/i,
  /\bbroken\b/i,
  // ...
]
```

**Problem**: Any user message containing the word "error" triggers detection, including:
- Meta-discussions about the error detection feature itself
- Questions about how errors work
- Descriptions of what user is looking for (not actual issues)

**Impact**: Users discussing the hook feature itself triggered the hook, creating a recursive/ironic situation.

### Issue 3: Missing Context-Aware Exclusions

**Problem**: The exclusion patterns focus on conceptual discussions and future tense, but don't exclude:
- Meta-discussions about Claude Code features
- Grep/search commands looking for error patterns
- Reading log files or debug output

## Resolution

### Immediate Action (2026-02-05)

Disabled both hooks in `hooks.json`:
1. Removed PostToolUse:Bash matcher for `issue-detector-tool-hook.js`
2. Removed UserPromptSubmit entry for `user-issue-hook.js` (pending)

### Recommended Fixes

1. **Make `error:` pattern context-aware**
   - Only match at line start: `/^error:/im`
   - Or require additional context: `/error:.*failed|error:.*cannot/i`

2. **Add command-aware exclusions for Bash hook**
   - Skip detection for grep/rg commands
   - Skip detection for cat/tail of log files
   - Skip detection when reading debug output

3. **Add meta-discussion exclusions for UserPromptSubmit**
   - Exclude messages about "hook", "detection", "trigger"
   - Exclude messages asking about the feature itself

4. **Consider severity levels**
   - Non-zero exit code = high confidence (keep)
   - Pattern match alone = low confidence (require multiple signals)

## Lessons Learned

1. Error detection patterns need extensive real-world testing before deployment
2. Hooks that trigger on content they're designed to detect create feedback loops
3. Broad regex patterns cause more noise than value in development workflows
4. Consider opt-in vs always-on for aggressive detection features

## Files Involved

- `/Users/royengel/.claude/hooks.json` - Configuration
- `/Users/royengel/.claude/hooks/scripts/detect-issue.js` - Detection logic
- `/Users/royengel/.claude/hooks/scripts/issue-detector-tool-hook.js` - Bash hook
- `/Users/royengel/.claude/hooks/scripts/user-issue-hook.js` - User message hook
